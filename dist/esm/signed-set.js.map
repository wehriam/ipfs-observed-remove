{"version":3,"sources":["../../src/signed-set.js"],"names":["SignedObservedRemoveSet","parser","jsonStreamParser","CID","streamArray","jsonStreamArray","LruCache","PQueue","debounce","Readable","SerializeTransform","DeserializeTransform","notSubscribedRegex","IpfsSignedObservedRemoveSet","constructor","ipfs","topic","entries","options","Error","chunkPubSub","abortController","AbortController","active","disableSync","boundHandleQueueMessage","handleQueueMessage","bind","boundHandleHashMessage","handleHashMessage","readyPromise","initIpfs","remoteHashQueue","syncCache","peersCache","max","maxAge","hasNewPeers","on","ipfsHash","isLoadingHashes","debouncedIpfsSync","ipfsSync","serializeTransform","autoDestroy","maxChunkSize","messageSlice","pubsub","publish","toString","signal","error","type","emit","deserializeTransform","timeout","message","queue","JSON","parse","process","hashLoadQueue","id","ipfsId","Buffer","from","stringify","write","promises","subscribe","discover","push","waitForPeersThenSendHash","Promise","all","peerIds","peers","length","resolve","setTimeout","setImmediate","code","name","hash","getIpfsHash","has","set","dump","flush","insertQueue","deleteQueue","sort","x","y","data","file","add","wrapWithDirectory","recursive","pin","cid","ipfsPeerCount","shutdown","unsubscribeAbortController","abort","unsubscribe","clearTimeout","test","remoteHash","loadIpfsHash","loadIpfsHashes","pop","stream","cat","pipeline","pipe","arrayDepth","streamState","insertions","deletions","value","i","d","reject"],"mappings":"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","sourcesContent":["// @flow\n\nimport { SignedObservedRemoveSet } from 'observed-remove';\nimport { parser as jsonStreamParser } from 'stream-json/Parser';\nimport CID from 'cids';\n\nimport { streamArray as jsonStreamArray } from 'stream-json/streamers/StreamArray';\nimport LruCache from 'lru-cache';\nimport PQueue from 'p-queue';\nimport debounce from 'lodash/debounce';\nimport { Readable } from 'stream';\nimport {\n  SerializeTransform,\n  DeserializeTransform,\n} from '@bunchtogether/chunked-stream-transformers';\n\ntype Options = {\n  maxAge?:number,\n  bufferPublishing?:number,\n  key?: any,\n  format?: string,\n  disableSync?: boolean,\n  chunkPubSub?: boolean\n};\n\nconst notSubscribedRegex = /Not subscribed/;\n\nexport default class IpfsSignedObservedRemoveSet<V> extends SignedObservedRemoveSet<V> { // eslint-disable-line no-unused-vars\n  /**\n   * Create an observed-remove CRDT.\n   * @param {Object} [ipfs] Object implementing the [core IPFS API](https://github.com/ipfs/interface-ipfs-core#api), most likely a [js-ipfs](https://github.com/ipfs/js-ipfs) or [ipfs-http-client](https://github.com/ipfs/js-ipfs-http-client) object.\n   * @param {String} [topic] IPFS pubub topic to use in synchronizing the CRDT.\n   * @param {Iterable<V>} [entries=[]] Iterable of initial values\n   * @param {Object} [options={}]\n   * @param {String} [options.maxAge=5000] Max age of insertion/deletion identifiers\n   * @param {String} [options.bufferPublishing=20] Interval by which to buffer 'publish' events\n   */\n  constructor(ipfs:Object, topic:string, entries?: Iterable<[V, string, string]>, options?:Options = {}) {\n    super(entries, options);\n    if (!ipfs) {\n      throw new Error(\"Missing required argument 'ipfs'\");\n    }\n    this.chunkPubSub = !!options.chunkPubSub;\n    this.ipfs = ipfs;\n    this.abortController = new AbortController();\n    this.topic = topic;\n    this.active = true;\n    this.disableSync = !!options.disableSync;\n    this.boundHandleQueueMessage = this.handleQueueMessage.bind(this);\n    this.boundHandleHashMessage = this.handleHashMessage.bind(this);\n    this.readyPromise = this.initIpfs();\n    this.remoteHashQueue = [];\n\n    this.syncCache = new LruCache(100);\n    this.peersCache = new LruCache({\n      max: 100,\n      maxAge: 1000 * 60,\n    });\n    this.hasNewPeers = false;\n    this.on('add', () => {\n      delete this.ipfsHash;\n    });\n    this.on('delete', () => {\n      delete this.ipfsHash;\n    });\n    this.isLoadingHashes = false;\n    this.debouncedIpfsSync = debounce(this.ipfsSync.bind(this), 1000);\n    this.serializeTransform = new SerializeTransform({\n      autoDestroy: false,\n      maxChunkSize: 1024 * 512,\n    });\n    this.serializeTransform.on('data', async (messageSlice) => {\n      try {\n        await this.ipfs.pubsub.publish(this.topic, messageSlice.toString('base64'), { signal: this.abortController.signal });\n      } catch (error) {\n        if (error.type !== 'aborted') {\n          this.emit('error', error);\n        }\n      }\n    });\n    this.serializeTransform.on('error', (error) => {\n      this.emit('error', error);\n    });\n    this.deserializeTransform = new DeserializeTransform({\n      autoDestroy: false,\n      timeout: 10000,\n    });\n    this.deserializeTransform.on('error', (error) => {\n      this.emit('error', error);\n    });\n    this.deserializeTransform.on('data', (message) => {\n      try {\n        const queue = JSON.parse(message.toString('utf8'));\n        this.process(queue);\n      } catch (error) {\n        this.emit('error', error);\n      }\n    });\n    this.hashLoadQueue = new PQueue({});\n    this.hashLoadQueue.on('idle', () => {\n      if (this.hasNewPeers) {\n        this.debouncedIpfsSync();\n      }\n      this.emit('hashesloaded');\n    });\n  }\n\n  /**\n   * Resolves when IPFS topic subscriptions are confirmed.\n   *\n   * @name IpfsObservedRemoveSet#readyPromise\n   * @type {Promise<void>}\n   * @readonly\n   */\n\n  declare ipfs: Object;\n  declare topic: string;\n  declare readyPromise: Promise<void>;\n  declare active: boolean;\n  declare ipfsId: string;\n  declare disableSync: boolean;\n  declare boundHandleQueueMessage: (message:{from:string, data:Buffer}) => Promise<void>;\n  declare boundHandleHashMessage: (message:{from:string, data:Buffer}) => Promise<void>;\n  declare db: Object;\n  declare ipfsHash: string | void;\n  declare syncCache: LruCache;\n  declare peersCache: LruCache;\n  declare hasNewPeers: boolean;\n  declare remoteHashQueue: Array<string>;\n  declare isLoadingHashes: boolean;\n  declare debouncedIpfsSync: () => Promise<void>;\n  declare abortController: AbortController;\n  declare chunkPubSub: boolean;\n  declare serializeTransform: SerializeTransform;\n  declare deserializeTransform: DeserializeTransform;\n  declare hashLoadQueue: PQueue;\n\n  async initIpfs() {\n    try {\n      const { id } = await this.ipfs.id({ signal: this.abortController.signal });\n      this.ipfsId = id;\n    } catch (error) {\n      if (error.type !== 'aborted') {\n        throw error;\n      }\n      return;\n    }\n    this.on('publish', async (queue) => {\n      if (!this.active) {\n        return;\n      }\n      if (this.chunkPubSub) {\n        const message = Buffer.from(JSON.stringify(queue));\n        this.serializeTransform.write(message);\n      } else {\n        try {\n          const message = Buffer.from(JSON.stringify(queue));\n          await this.ipfs.pubsub.publish(this.topic, message, { signal: this.abortController.signal });\n        } catch (error) {\n          if (error.type !== 'aborted') {\n            this.emit('error', error);\n          }\n        }\n      }\n    });\n    try {\n      const promises = [this.ipfs.pubsub.subscribe(this.topic, this.boundHandleQueueMessage, { discover: true, signal: this.abortController.signal })];\n      if (!this.disableSync) {\n        promises.push(this.ipfs.pubsub.subscribe(`${this.topic}:hash`, this.boundHandleHashMessage, { discover: true, signal: this.abortController.signal }));\n        this.waitForPeersThenSendHash();\n      }\n      await Promise.all(promises);\n    } catch (error) {\n      if (error.type !== 'aborted') {\n        throw error;\n      }\n    }\n  }\n\n  async waitForPeersThenSendHash():Promise<void> {\n    if (!this.active) {\n      return;\n    }\n\n\n    try {\n      const peerIds = await this.ipfs.pubsub.peers(this.topic, { timeout: 10000, signal: this.abortController.signal });\n      if (peerIds.length > 0) {\n        this.debouncedIpfsSync();\n      } else {\n        await new Promise((resolve) => setTimeout(resolve, 10000));\n        setImmediate(() => {\n          this.waitForPeersThenSendHash();\n        });\n      }\n    } catch (error) {\n      // IPFS connection is closed or timed out, don't send join\n      if (error.type !== 'aborted' && error.code !== 'ECONNREFUSED' && error.name !== 'TimeoutError') {\n        this.emit('error', error);\n      }\n      if (this.active && error.name === 'TimeoutError') {\n        setImmediate(() => {\n          this.waitForPeersThenSendHash();\n        });\n      }\n    }\n  }\n\n  /**\n   * Publish an IPFS hash of an array containing all of the object's insertions and deletions.\n   * @return {Array<Array<any>>}\n   */\n  async ipfsSync() {\n    if (!this.active) {\n      return;\n    }\n    try {\n      const hash = await this.getIpfsHash();\n      if (!this.active) {\n        return;\n      }\n      if (!this.syncCache.has(hash, true) || this.hasNewPeers) {\n        this.hasNewPeers = false;\n        this.syncCache.set(hash, true);\n        await this.ipfs.pubsub.publish(`${this.topic}:hash`, Buffer.from(hash, 'utf8'), { signal: this.abortController.signal });\n        this.emit('hash', hash);\n      }\n    } catch (error) {\n      if (error.type !== 'aborted') {\n        this.emit('error', error);\n      }\n    }\n  }\n\n  /**\n   * Return a sorted array containing all of the set's insertions and deletions.\n   * @return {[Array<*>, Array<*>]>}\n   */\n  dump() {\n    this.flush();\n    const [insertQueue, deleteQueue] = super.dump();\n    deleteQueue.sort((x, y) => (x[0] > y[0] ? -1 : 1));\n    insertQueue.sort((x, y) => (x[0] > y[0] ? -1 : 1));\n    return [insertQueue, deleteQueue];\n  }\n\n  /**\n   * Stores and returns an IPFS hash of the current insertions and deletions\n   * @return {Promise<string>}\n   */\n  async getIpfsHash():Promise<string> {\n    if (this.ipfsHash) {\n      return this.ipfsHash;\n    }\n    const data = this.dump();\n    const file = await this.ipfs.add(Buffer.from(JSON.stringify(data)), { wrapWithDirectory: false, recursive: false, pin: false, signal: this.abortController.signal });\n    this.ipfsHash = file.cid.toString();\n    return this.ipfsHash;\n  }\n\n  /**\n   * Current number of IPFS pubsub peers.\n   * @return {number}\n   */\n  async ipfsPeerCount():Promise<number> {\n    const peerIds = await this.ipfs.pubsub.peers(this.topic, { signal: this.abortController.signal });\n    return peerIds.length;\n  }\n\n  /**\n   * Gracefully shutdown\n   * @return {void}\n   */\n  async shutdown(): Promise<void> {\n    this.active = false;\n    // Catch exceptions here as pubsub is sometimes closed by process kill signals.\n    if (this.ipfsId) {\n      try {\n        const unsubscribeAbortController = new AbortController();\n        const timeout = setTimeout(() => {\n          unsubscribeAbortController.abort();\n        }, 5000);\n        const promises = [this.ipfs.pubsub.unsubscribe(this.topic, this.boundHandleQueueMessage, { signal: unsubscribeAbortController.signal })];\n        if (!this.disableSync) {\n          promises.push(this.ipfs.pubsub.unsubscribe(`${this.topic}:hash`, this.boundHandleHashMessage, { signal: unsubscribeAbortController.signal }));\n        }\n        await Promise.all(promises);\n        clearTimeout(timeout);\n      } catch (error) {\n        if (!notSubscribedRegex.test(error.message)) {\n          this.abortController.abort();\n          this.abortController = new AbortController();\n          throw error;\n        }\n      }\n    }\n    this.abortController.abort();\n    this.abortController = new AbortController();\n  }\n\n  handleQueueMessage(message:{from:string, data:Buffer}) {\n    if (message.from === this.ipfsId) {\n      return;\n    }\n    if (!this.active) {\n      return;\n    }\n    if (this.chunkPubSub) {\n      this.deserializeTransform.write(Buffer.from(Buffer.from(message.data).toString(), 'base64'));\n    } else {\n      try {\n        const queue = JSON.parse(Buffer.from(message.data).toString('utf8'));\n        this.process(queue);\n      } catch (error) {\n        this.emit('error', error);\n      }\n    }\n  }\n\n  handleHashMessage(message:{from:string, data:Buffer}) {\n    if (!this.active) {\n      return;\n    }\n    if (message.from === this.ipfsId) {\n      return;\n    }\n    if (!this.peersCache.has(message.from)) {\n      this.hasNewPeers = true;\n      this.peersCache.set(message.from, true);\n    }\n    const remoteHash = Buffer.from(message.data).toString('utf8');\n    if (this.syncCache.has(remoteHash)) {\n      return;\n    }\n    this.syncCache.set(remoteHash, true);\n    try {\n      this.hashLoadQueue.add(() => this.loadIpfsHash(remoteHash));\n    } catch (error) {\n      this.emit('error', error);\n    }\n  }\n\n  async loadIpfsHashes() {\n    if (this.isLoadingHashes) {\n      return;\n    }\n    this.isLoadingHashes = true;\n    try {\n      while (this.remoteHashQueue.length > 0 && this.active && this.isLoadingHashes) {\n        const remoteHash = this.remoteHashQueue.pop();\n        if (this.syncCache.has(remoteHash)) {\n          continue;\n        }\n        this.syncCache.set(remoteHash, true);\n        await this.loadIpfsHash(remoteHash);\n      }\n    } catch (error) {\n      this.emit('error', error);\n    }\n    this.isLoadingHashes = false;\n    this.debouncedIpfsSync();\n  }\n\n  async loadIpfsHash(hash:string) {\n    // $FlowFixMe\n    const stream = Readable.from(this.ipfs.cat(new CID(hash), { timeout: 30000, signal: this.abortController.signal }));\n    const parser = jsonStreamParser();\n    const streamArray = jsonStreamArray();\n    const pipeline = stream.pipe(parser);\n    let arrayDepth = 0;\n    let streamState = 0;\n    let insertions = [];\n    let deletions = [];\n    streamArray.on('data', ({ value }) => {\n      if (streamState === 1) {\n        insertions.push(value);\n      } else if (streamState === 3) {\n        deletions.push(value);\n      }\n      if (insertions.length + deletions.length < 1000) {\n        return;\n      }\n      const i = insertions;\n      const d = deletions;\n      insertions = [];\n      deletions = [];\n      this.process([i, d], true);\n    });\n    try {\n      await new Promise((resolve, reject) => {\n        stream.on('error', (error) => {\n          reject(error);\n        });\n        streamArray.on('error', (error) => {\n          reject(error);\n        });\n        pipeline.on('error', (error) => {\n          reject(error);\n        });\n        pipeline.on('end', () => {\n          resolve();\n        });\n        pipeline.on('data', (data) => {\n          const { name } = data;\n          if (name === 'startArray') {\n            arrayDepth += 1;\n            if (arrayDepth === 2) {\n              streamState += 1;\n            }\n          }\n          if (streamState === 1 || streamState === 3) {\n            streamArray.write(data);\n          }\n          if (name === 'endArray') {\n            if (arrayDepth === 2) {\n              streamState += 1;\n            }\n            arrayDepth -= 1;\n          }\n        });\n      });\n    } catch (error) {\n      if (error.type !== 'aborted') {\n        this.emit('error', error);\n      }\n      return;\n    }\n    this.process([insertions, deletions]);\n  }\n}\n\n"],"file":"signed-set.js"}